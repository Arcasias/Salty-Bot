import Command from "../../classes/Command";
import { MissingArg } from "../../classes/Exception";
import PromiseManager from "../../classes/PromiseManager";
import Salty from "../../classes/Salty";
async function changeNames(msg, transformation) {
    const members = msg.guild.members.array();
    const progressMsg = await Salty.message(msg, `changing nicknames: 0/${members.length}`);
    const pm = new PromiseManager();
    for (let i = 0; i < members.length; i++) {
        const newNick = transformation(members[i].nickname ? members[i].nickname : members[i].user.username);
        if (newNick !== members[i].nickname) {
            try {
                await members[i].setNickname(newNick);
                pm.add(progressMsg.edit.bind(progressMsg, `changing nicknames: ${i++}/${members.length}`));
            }
            catch (err) {
                if (err.name !== "DiscordAPIError" ||
                    err.message !== "Missing Permissions") {
                    throw err;
                }
            }
        }
        else {
            pm.add(progressMsg.edit.bind(progressMsg, `changing nicknames: ${i++}/${members.length}`));
        }
    }
    pm.add(progressMsg.delete.bind(progressMsg));
    Salty.success(msg, "nicknames successfully changed");
}
export default new Command({
    name: "nickname",
    keys: ["name", "nick", "pseudo"],
    help: [
        {
            argument: null,
            effect: null,
        },
        {
            argument: "add ***particle***",
            effect: "Appends the ***particle*** to every possible nickname in the server. Careful to not exceed 32 characters !",
        },
        {
            argument: "remove ***particle***",
            effect: "Removes the ***particle*** from each matching nickname",
        },
    ],
    visibility: "admin",
    async action(msg, args) {
        const particle = args.slice(1).join(" ");
        const particleRegex = new RegExp(particle, "g");
        const addList = Salty.getList("add");
        const removeList = Salty.getList("delete");
        if (!args[0]) {
            throw new MissingArg("add or delete + particle");
        }
        else {
            if (!particle) {
                throw new MissingArg("nickname particle");
            }
            if (addList.includes(args[0])) {
                await changeNames.call(this, msg, (nickname) => nickname.match(particleRegex)
                    ? nickname
                    : `${nickname.trim()} ${particle}`);
            }
            else if (removeList.includes(args[0])) {
                await changeNames.call(this, msg, (nickname) => nickname.replace(particleRegex, "").trim());
            }
            else {
                throw new MissingArg("add or delete + particle");
            }
        }
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmlja25hbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbWFuZHMvY29uZmlnL25pY2tuYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sT0FBTyxNQUFNLHVCQUF1QixDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLGNBQWMsTUFBTSw4QkFBOEIsQ0FBQztBQUMxRCxPQUFPLEtBQUssTUFBTSxxQkFBcUIsQ0FBQztBQUV4QyxLQUFLLFVBQVUsV0FBVyxDQUFDLEdBQUcsRUFBRSxjQUFjO0lBQzFDLE1BQU0sT0FBTyxHQUFrQixHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN6RCxNQUFNLFdBQVcsR0FBWSxNQUFNLEtBQUssQ0FBQyxPQUFPLENBQzVDLEdBQUcsRUFDSCx5QkFBeUIsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUM1QyxDQUFDO0lBQ0YsTUFBTSxFQUFFLEdBQW1CLElBQUksY0FBYyxFQUFFLENBQUM7SUFDaEQsS0FBSyxJQUFJLENBQUMsR0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDN0MsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUMxQixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FDdkUsQ0FBQztRQUNGLElBQUksT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDakMsSUFBSTtnQkFDQSxNQUFNLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3RD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Q0FBQywwQkFBMEIsQ0FBQyxDQUFDO2FBQ3BEO1NBQ0o7SUFDTCxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3VpbGRNZW1iZXIsIE1lc3NhZ2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xuaW1wb3J0IENvbW1hbmQgZnJvbSBcIi4uLy4uL2NsYXNzZXMvQ29tbWFuZFwiO1xuaW1wb3J0IHsgTWlzc2luZ0FyZyB9IGZyb20gXCIuLi8uLi9jbGFzc2VzL0V4Y2VwdGlvblwiO1xuaW1wb3J0IFByb21pc2VNYW5hZ2VyIGZyb20gXCIuLi8uLi9jbGFzc2VzL1Byb21pc2VNYW5hZ2VyXCI7XG5pbXBvcnQgU2FsdHkgZnJvbSBcIi4uLy4uL2NsYXNzZXMvU2FsdHlcIjtcblxuYXN5bmMgZnVuY3Rpb24gY2hhbmdlTmFtZXMobXNnLCB0cmFuc2Zvcm1hdGlvbikge1xuICAgIGNvbnN0IG1lbWJlcnM6IEd1aWxkTWVtYmVyW10gPSBtc2cuZ3VpbGQubWVtYmVycy5hcnJheSgpO1xuICAgIGNvbnN0IHByb2dyZXNzTXNnOiBNZXNzYWdlID0gYXdhaXQgU2FsdHkubWVzc2FnZShcbiAgICAgICAgbXNnLFxuICAgICAgICBgY2hhbmdpbmcgbmlja25hbWVzOiAwLyR7bWVtYmVycy5sZW5ndGh9YFxuICAgICk7XG4gICAgY29uc3QgcG06IFByb21pc2VNYW5hZ2VyID0gbmV3IFByb21pc2VNYW5hZ2VyKCk7XG4gICAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IG1lbWJlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgbmV3TmljayA9IHRyYW5zZm9ybWF0aW9uKFxuICAgICAgICAgICAgbWVtYmVyc1tpXS5uaWNrbmFtZSA/IG1lbWJlcnNbaV0ubmlja25hbWUgOiBtZW1iZXJzW2ldLnVzZXIudXNlcm5hbWVcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKG5ld05pY2sgIT09IG1lbWJlcnNbaV0ubmlja25hbWUpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgbWVtYmVyc1tpXS5zZXROaWNrbmFtZShuZXdOaWNrKTtcbiAgICAgICAgICAgICAgICBwbS5hZGQoXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzTXNnLmVkaXQuYmluZChcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzTXNnLFxuICAgICAgICAgICAgICAgICAgICAgICAgYGNoYW5naW5nIG5pY2tuYW1lczogJHtpKyt9LyR7bWVtYmVycy5sZW5ndGh9YFxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgIT09IFwiRGlzY29yZEFQSUVycm9yXCIgfHxcbiAgICAgICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UgIT09IFwiTWlzc2luZyBQZXJtaXNzaW9uc1wiXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBwbS5hZGQoXG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NNc2cuZWRpdC5iaW5kKFxuICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc01zZyxcbiAgICAgICAgICAgICAgICAgICAgYGNoYW5naW5nIG5pY2tuYW1lczogJHtpKyt9LyR7bWVtYmVycy5sZW5ndGh9YFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcG0uYWRkKHByb2dyZXNzTXNnLmRlbGV0ZS5iaW5kKHByb2dyZXNzTXNnKSk7XG4gICAgU2FsdHkuc3VjY2Vzcyhtc2csIFwibmlja25hbWVzIHN1Y2Nlc3NmdWxseSBjaGFuZ2VkXCIpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgQ29tbWFuZCh7XG4gICAgbmFtZTogXCJuaWNrbmFtZVwiLFxuICAgIGtleXM6IFtcIm5hbWVcIiwgXCJuaWNrXCIsIFwicHNldWRvXCJdLFxuICAgIGhlbHA6IFtcbiAgICAgICAge1xuICAgICAgICAgICAgYXJndW1lbnQ6IG51bGwsXG4gICAgICAgICAgICBlZmZlY3Q6IG51bGwsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFyZ3VtZW50OiBcImFkZCAqKipwYXJ0aWNsZSoqKlwiLFxuICAgICAgICAgICAgZWZmZWN0OlxuICAgICAgICAgICAgICAgIFwiQXBwZW5kcyB0aGUgKioqcGFydGljbGUqKiogdG8gZXZlcnkgcG9zc2libGUgbmlja25hbWUgaW4gdGhlIHNlcnZlci4gQ2FyZWZ1bCB0byBub3QgZXhjZWVkIDMyIGNoYXJhY3RlcnMgIVwiLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBhcmd1bWVudDogXCJyZW1vdmUgKioqcGFydGljbGUqKipcIixcbiAgICAgICAgICAgIGVmZmVjdDogXCJSZW1vdmVzIHRoZSAqKipwYXJ0aWNsZSoqKiBmcm9tIGVhY2ggbWF0Y2hpbmcgbmlja25hbWVcIixcbiAgICAgICAgfSxcbiAgICBdLFxuICAgIHZpc2liaWxpdHk6IFwiYWRtaW5cIixcbiAgICBhc3luYyBhY3Rpb24obXNnLCBhcmdzKSB7XG4gICAgICAgIGNvbnN0IHBhcnRpY2xlOiBzdHJpbmcgPSBhcmdzLnNsaWNlKDEpLmpvaW4oXCIgXCIpO1xuICAgICAgICBjb25zdCBwYXJ0aWNsZVJlZ2V4OiBSZWdFeHAgPSBuZXcgUmVnRXhwKHBhcnRpY2xlLCBcImdcIik7XG5cbiAgICAgICAgY29uc3QgYWRkTGlzdDogc3RyaW5nW10gPSBTYWx0eS5nZXRMaXN0KFwiYWRkXCIpO1xuICAgICAgICBjb25zdCByZW1vdmVMaXN0OiBzdHJpbmdbXSA9IFNhbHR5LmdldExpc3QoXCJkZWxldGVcIik7XG5cbiAgICAgICAgaWYgKCFhcmdzWzBdKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTWlzc2luZ0FyZyhcImFkZCBvciBkZWxldGUgKyBwYXJ0aWNsZVwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghcGFydGljbGUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTWlzc2luZ0FyZyhcIm5pY2tuYW1lIHBhcnRpY2xlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFkZExpc3QuaW5jbHVkZXMoYXJnc1swXSkpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBjaGFuZ2VOYW1lcy5jYWxsKHRoaXMsIG1zZywgKG5pY2tuYW1lKSA9PlxuICAgICAgICAgICAgICAgICAgICBuaWNrbmFtZS5tYXRjaChwYXJ0aWNsZVJlZ2V4KVxuICAgICAgICAgICAgICAgICAgICAgICAgPyBuaWNrbmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBgJHtuaWNrbmFtZS50cmltKCl9ICR7cGFydGljbGV9YFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlbW92ZUxpc3QuaW5jbHVkZXMoYXJnc1swXSkpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBjaGFuZ2VOYW1lcy5jYWxsKHRoaXMsIG1zZywgKG5pY2tuYW1lKSA9PlxuICAgICAgICAgICAgICAgICAgICBuaWNrbmFtZS5yZXBsYWNlKHBhcnRpY2xlUmVnZXgsIFwiXCIpLnRyaW0oKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBNaXNzaW5nQXJnKFwiYWRkIG9yIGRlbGV0ZSArIHBhcnRpY2xlXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbn0pO1xuIl19