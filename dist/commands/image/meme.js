import fs from "fs";
import http from "http";
import https from "https";
import path from "path";
import PImage from "pureimage";
import Command from "../../classes/Command";
import Salty from "../../classes/Salty";
import { error, title } from "../../utils";
const defaultWidth = 450;
const maxTempImages = 5;
const fontFamily = "helvetica";
const baseFontSize = 24;
const baseLineSpace = 30;
const baseBorder = 10;
let imgIndex = 1;
let imgPath = path.join(Salty.config.tempImageFolder, `meme_temp_${imgIndex}.png`);
export default new Command({
    name: "meme",
    keys: ["memes"],
    help: [
        {
            argument: null,
            effect: "Work in progress",
        },
    ],
    visibility: "public",
    mode: "local",
    async action(msg, args) {
        let canvas, c, fontSize, border, lineSpace;
        const imgURL = msg.attachments.first()
            ? msg.attachments.first().url
            : null;
        let imgText = args.length > 0
            ? args
                .join(" ")
                .split("\\")
                .map((line) => title(line))
            : null;
        let imgOffset;
        if (!Array.isArray(imgText))
            imgText = [imgText];
        // First step : find an image and create a canvas from it, or a blank canvas if no image is found.
        if (imgURL) {
            function urlDecode(res) {
                PImage.decodePNGFromStream(res).then((img) => {
                    let mult, surface = img.width * img.height;
                    if (surface >= 500000)
                        mult = 3;
                    else if (surface >= 420000)
                        mult = 2.5;
                    else if (surface >= 250000)
                        mult = 2;
                    else if (surface >= 170000)
                        mult = 1.5;
                    else
                        mult = 1;
                    fontSize = baseFontSize * mult;
                    lineSpace = baseLineSpace * mult;
                    border = baseBorder * mult;
                    imgOffset = border * 2 + imgText.length * lineSpace;
                    canvas = PImage.make(img.width, img.height + imgOffset);
                    c = canvas.getContext("2d");
                    c.fillStyle = "#ffffff";
                    c.fillRect(0, 0, img.width, img.height + imgOffset);
                    c.drawImage(img, 0, imgOffset);
                    textHandler();
                });
            }
            // Chooses from http or https
            imgURL.startsWith("https")
                ? https.get(imgURL, urlDecode)
                : http.get(imgURL, urlDecode);
        }
        else {
            fontSize = baseFontSize;
            lineSpace = baseLineSpace;
            border = baseBorder;
            imgOffset = border * 2 + imgText.length * lineSpace;
            canvas = PImage.make(defaultWidth, imgOffset);
            c = canvas.getContext("2d");
            c.fillStyle = "#ffffff";
            c.fillRect(0, 0, defaultWidth, imgOffset);
            textHandler();
        }
        // Second step : apply text on canvas if needed.
        function textHandler() {
            if (imgText[0]) {
                let font = PImage.registerFont(`assets/fonts/${fontFamily}.ttf`, fontFamily);
                font.load(() => {
                    c.font = `${fontSize}pt ${fontFamily}`;
                    imgText.forEach((line) => {
                        let metrics = c.measureText(line);
                        while (metrics.width > canvas.width * 0.9) {
                            fontSize -= 2;
                            c.font = `${fontSize}pt ${fontFamily}`;
                            metrics = c.measureText(line);
                        }
                    });
                    for (let i = 0; i < Math.min(imgText.length, 2); i++) {
                        const metrics = c.measureText(imgText[i]);
                        c.fillStyle = "#000000";
                        c.fillText(imgText[i].trim(), border, border + metrics.emHeightAscent + i * lineSpace);
                    }
                    sendCanvas();
                });
            }
            else {
                sendCanvas();
            }
        }
        // Last step : send canvas.
        function sendCanvas() {
            PImage.encodePNGToStream(canvas, fs.createWriteStream(imgPath))
                .then(() => {
                Salty.message(msg, null, imgPath).then(() => {
                    msg.delete();
                    imgIndex =
                        imgIndex >= maxTempImages - 1 ? 1 : imgIndex + 1;
                    imgPath = path.join(Salty.config.tempImageFolder, `meme_temp_${imgIndex}.png`);
                });
            })
                .catch(error);
        }
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9pbWFnZS9tZW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQzFCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLE1BQU0sTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUM7QUFDNUMsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUM7QUFDeEMsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFM0MsTUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFDO0FBQ3pCLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQztBQUN4QixNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUM7QUFDL0IsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztBQUN6QixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7QUFFdEIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0FBQ2pCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQ25CLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUM1QixhQUFhLFFBQVEsTUFBTSxDQUM5QixDQUFDO0FBRUYsZUFBZSxJQUFJLE9BQU8sQ0FBQztJQUN2QixJQUFJLEVBQUUsTUFBTTtJQUNaLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUNmLElBQUksRUFBRTtRQUNGO1lBQ0ksUUFBUSxFQUFFLElBQUk7WUFDZCxNQUFNLEVBQUUsa0JBQWtCO1NBQzdCO0tBQ0o7SUFDRCxVQUFVLEVBQUUsUUFBUTtJQUNwQixJQUFJLEVBQUUsT0FBTztJQUNi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QztZQUNQLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEIsQ0FBQztJQUNMLENBQUM7Q0FDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgaHR0cCBmcm9tIFwiaHR0cFwiO1xuaW1wb3J0IGh0dHBzIGZyb20gXCJodHRwc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCBQSW1hZ2UgZnJvbSBcInB1cmVpbWFnZVwiO1xuaW1wb3J0IENvbW1hbmQgZnJvbSBcIi4uLy4uL2NsYXNzZXMvQ29tbWFuZFwiO1xuaW1wb3J0IFNhbHR5IGZyb20gXCIuLi8uLi9jbGFzc2VzL1NhbHR5XCI7XG5pbXBvcnQgeyBlcnJvciwgdGl0bGUgfSBmcm9tIFwiLi4vLi4vdXRpbHNcIjtcblxuY29uc3QgZGVmYXVsdFdpZHRoID0gNDUwO1xuY29uc3QgbWF4VGVtcEltYWdlcyA9IDU7XG5jb25zdCBmb250RmFtaWx5ID0gXCJoZWx2ZXRpY2FcIjtcbmNvbnN0IGJhc2VGb250U2l6ZSA9IDI0O1xuY29uc3QgYmFzZUxpbmVTcGFjZSA9IDMwO1xuY29uc3QgYmFzZUJvcmRlciA9IDEwO1xuXG5sZXQgaW1nSW5kZXggPSAxO1xubGV0IGltZ1BhdGggPSBwYXRoLmpvaW4oXG4gICAgU2FsdHkuY29uZmlnLnRlbXBJbWFnZUZvbGRlcixcbiAgICBgbWVtZV90ZW1wXyR7aW1nSW5kZXh9LnBuZ2Bcbik7XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBDb21tYW5kKHtcbiAgICBuYW1lOiBcIm1lbWVcIixcbiAgICBrZXlzOiBbXCJtZW1lc1wiXSxcbiAgICBoZWxwOiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFyZ3VtZW50OiBudWxsLFxuICAgICAgICAgICAgZWZmZWN0OiBcIldvcmsgaW4gcHJvZ3Jlc3NcIixcbiAgICAgICAgfSxcbiAgICBdLFxuICAgIHZpc2liaWxpdHk6IFwicHVibGljXCIsXG4gICAgbW9kZTogXCJsb2NhbFwiLFxuICAgIGFzeW5jIGFjdGlvbihtc2csIGFyZ3MpIHtcbiAgICAgICAgbGV0IGNhbnZhcywgYywgZm9udFNpemUsIGJvcmRlciwgbGluZVNwYWNlO1xuICAgICAgICBjb25zdCBpbWdVUkwgPSBtc2cuYXR0YWNobWVudHMuZmlyc3QoKVxuICAgICAgICAgICAgPyBtc2cuYXR0YWNobWVudHMuZmlyc3QoKS51cmxcbiAgICAgICAgICAgIDogbnVsbDtcbiAgICAgICAgbGV0IGltZ1RleHQgPVxuICAgICAgICAgICAgYXJncy5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgPyBhcmdzXG4gICAgICAgICAgICAgICAgICAgICAgLmpvaW4oXCIgXCIpXG4gICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KFwiXFxcXFwiKVxuICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGxpbmUpID0+IHRpdGxlKGxpbmUpKVxuICAgICAgICAgICAgICAgIDogbnVsbDtcblxuICAgICAgICBsZXQgaW1nT2Zmc2V0O1xuXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShpbWdUZXh0KSkgaW1nVGV4dCA9IFtpbWdUZXh0XTtcblxuICAgICAgICAvLyBGaXJzdCBzdGVwIDogZmluZCBhbiBpbWFnZSBhbmQgY3JlYXRlIGEgY2FudmFzIGZyb20gaXQsIG9yIGEgYmxhbmsgY2FudmFzIGlmIG5vIGltYWdlIGlzIGZvdW5kLlxuICAgICAgICBpZiAoaW1nVVJMKSB7XG4gICAgICAgICAgICBmdW5jdGlvbiB1cmxEZWNvZGUocmVzKSB7XG4gICAgICAgICAgICAgICAgUEltYWdlLmRlY29kZVBOR0Zyb21TdHJlYW0ocmVzKS50aGVuKChpbWcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG11bHQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdXJmYWNlID0gaW1nLndpZHRoICogaW1nLmhlaWdodDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3VyZmFjZSA+PSA1MDAwMDApIG11bHQgPSAzO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzdXJmYWNlID49IDQyMDAwMCkgbXVsdCA9IDIuNTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc3VyZmFjZSA+PSAyNTAwMDApIG11bHQgPSAyO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzdXJmYWNlID49IDE3MDAwMCkgbXVsdCA9IDEuNTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBtdWx0ID0gMTtcblxuICAgICAgICAgICAgICAgICAgICBmb250U2l6ZSA9IGJhc2VGb250U2l6ZSAqIG11bHQ7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVTcGFjZSA9IGJhc2VMaW5lU3BhY2UgKiBtdWx0O1xuICAgICAgICAgICAgICAgICAgICBib3JkZXIgPSBiYXNlQm9yZGVyICogbXVsdDtcblxuICAgICAgICAgICAgICAgICAgICBpbWdPZmZzZXQgPSBib3JkZXIgKiAyICsgaW1nVGV4dC5sZW5ndGggKiBsaW5lU3BhY2U7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FudmFzID0gUEltYWdlLm1ha2UoaW1nLndpZHRoLCBpbWcuaGVpZ2h0ICsgaW1nT2Zmc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgYyA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgYy5maWxsU3R5bGUgPSBcIiNmZmZmZmZcIjtcbiAgICAgICAgICAgICAgICAgICAgYy5maWxsUmVjdCgwLCAwLCBpbWcud2lkdGgsIGltZy5oZWlnaHQgKyBpbWdPZmZzZXQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGMuZHJhd0ltYWdlKGltZywgMCwgaW1nT2Zmc2V0KTtcblxuICAgICAgICAgICAgICAgICAgICB0ZXh0SGFuZGxlcigpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDaG9vc2VzIGZyb20gaHR0cCBvciBodHRwc1xuICAgICAgICAgICAgaW1nVVJMLnN0YXJ0c1dpdGgoXCJodHRwc1wiKVxuICAgICAgICAgICAgICAgID8gaHR0cHMuZ2V0KGltZ1VSTCwgdXJsRGVjb2RlKVxuICAgICAgICAgICAgICAgIDogaHR0cC5nZXQoaW1nVVJMLCB1cmxEZWNvZGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9udFNpemUgPSBiYXNlRm9udFNpemU7XG4gICAgICAgICAgICBsaW5lU3BhY2UgPSBiYXNlTGluZVNwYWNlO1xuICAgICAgICAgICAgYm9yZGVyID0gYmFzZUJvcmRlcjtcblxuICAgICAgICAgICAgaW1nT2Zmc2V0ID0gYm9yZGVyICogMiArIGltZ1RleHQubGVuZ3RoICogbGluZVNwYWNlO1xuXG4gICAgICAgICAgICBjYW52YXMgPSBQSW1hZ2UubWFrZShkZWZhdWx0V2lkdGgsIGltZ09mZnNldCk7XG4gICAgICAgICAgICBjID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcblxuICAgICAgICAgICAgYy5maWxsU3R5bGUgPSBcIiNmZmZmZmZcIjtcbiAgICAgICAgICAgIGMuZmlsbFJlY3QoMCwgMCwgZGVmYXVsdFdpZHRoLCBpbWdPZmZzZXQpO1xuXG4gICAgICAgICAgICB0ZXh0SGFuZGxlcigpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNlY29uZCBzdGVwIDogYXBwbHkgdGV4dCBvbiBjYW52YXMgaWYgbmVlZGVkLlxuICAgICAgICBmdW5jdGlvbiB0ZXh0SGFuZGxlcigpIHtcbiAgICAgICAgICAgIGlmIChpbWdUZXh0WzBdKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZvbnQgPSBQSW1hZ2UucmVnaXN0ZXJGb250KFxuICAgICAgICAgICAgICAgICAgICBgYXNzZXRzL2ZvbnRzLyR7Zm9udEZhbWlseX0udHRmYCxcbiAgICAgICAgICAgICAgICAgICAgZm9udEZhbWlseVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZm9udC5sb2FkKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYy5mb250ID0gYCR7Zm9udFNpemV9cHQgJHtmb250RmFtaWx5fWA7XG4gICAgICAgICAgICAgICAgICAgIGltZ1RleHQuZm9yRWFjaCgobGluZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1ldHJpY3MgPSBjLm1lYXN1cmVUZXh0KGxpbmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1ldHJpY3Mud2lkdGggPiBjYW52YXMud2lkdGggKiAwLjkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZSAtPSAyO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYy5mb250ID0gYCR7Zm9udFNpemV9cHQgJHtmb250RmFtaWx5fWA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0cmljcyA9IGMubWVhc3VyZVRleHQobGluZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKGltZ1RleHQubGVuZ3RoLCAyKTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXRyaWNzID0gYy5tZWFzdXJlVGV4dChpbWdUZXh0W2ldKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgYy5maWxsU3R5bGUgPSBcIiMwMDAwMDBcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGMuZmlsbFRleHQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nVGV4dFtpXS50cmltKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlciArIG1ldHJpY3MuZW1IZWlnaHRBc2NlbnQgKyBpICogbGluZVNwYWNlXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNlbmRDYW52YXMoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2VuZENhbnZhcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIExhc3Qgc3RlcCA6IHNlbmQgY2FudmFzLlxuICAgICAgICBmdW5jdGlvbiBzZW5kQ2FudmFzKCkge1xuICAgICAgICAgICAgUEltYWdlLmVuY29kZVBOR1RvU3RyZWFtKGNhbnZhcywgZnMuY3JlYXRlV3JpdGVTdHJlYW0oaW1nUGF0aCkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBTYWx0eS5tZXNzYWdlKG1zZywgbnVsbCwgaW1nUGF0aCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtc2cuZGVsZXRlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGltZ0luZGV4ID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWdJbmRleCA+PSBtYXhUZW1wSW1hZ2VzIC0gMSA/IDEgOiBpbWdJbmRleCArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWdQYXRoID0gcGF0aC5qb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNhbHR5LmNvbmZpZy50ZW1wSW1hZ2VGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYG1lbWVfdGVtcF8ke2ltZ0luZGV4fS5wbmdgXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxufSk7XG4iXX0=