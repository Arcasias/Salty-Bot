import Command from "../../classes/Command";
import { IncorrectValue } from "../../classes/Exception";
import Salty from "../../classes/Salty";
import { title } from "../../utils";
export default new Command({
    name: "help",
    keys: ["halp", "info", "infos", "wtf", "?"],
    help: [
        {
            argument: null,
            effect: "Shows all of the available commands categories",
        },
        {
            argument: "***category***",
            effect: "Shows all of the available commands for a ***category***",
        },
        {
            argument: "***command***",
            effect: "Shows a detailed usage of a specific ***command***",
        },
    ],
    visibility: "public",
    async action(msg, args) {
        const { author } = msg;
        const options = {
            color: 0xffffff,
            fields: [],
        };
        const help = Salty.commands.help;
        const categories = {};
        // map name and technical name for enhanced search
        for (let category in help) {
            categories[category] = category;
            categories[help[category].info.name] = category;
        }
        const commands = Object.keys(Salty.commands.keys);
        if (args[0]) {
            const arg = args[0].toLowerCase();
            // query is a category name
            if (arg in categories) {
                const { name, description, icon } = help[categories[arg]].info;
                // arg === category
                options.title = `${icon} ${title(name)} commands`;
                options.description = `${description}. To get more information about a specific command, use the command \`$help command_name\``;
                help[categories[arg]].commands.forEach((cmd) => {
                    if ("public" === cmd.visibility ||
                        ("admin" === cmd.visibility &&
                            Salty.isAdmin(author, msg.guild)) ||
                        ("dev" === cmd.visibility && Salty.isDev(author)) ||
                        ("owner" === cmd.visibility && Salty.isOwner(author))) {
                        const alternate = cmd.keys.length
                            ? ` (or ***${cmd.keys.join("***, ***")}***)`
                            : "";
                        options.fields.push({
                            title: `**${title(cmd.name)}**${alternate}`,
                            description: `> \`${Salty.config.prefix}help ${cmd.name}\``,
                        });
                    }
                });
                // query is a command name
            }
            else if (commands.includes(arg)) {
                // arg === command
                const command = Salty.commands.list.get(Salty.commands.keys[arg]);
                const category = Object.values(categories).find((cat) => help[cat].commands.find((cmd) => cmd.name === command.name));
                options.title = `**${command.name.toUpperCase()}**`;
                options.url = `${Salty.config.homepage}/tree/master/commands/${category}/${command.name.toLowerCase()}.js`;
                options.description = `> ${title(category)}`;
                if (0 < command.keys.length) {
                    options.description += `\nAlternative usage: **${command.keys.join("**, **")}**`;
                }
                if (command.example) {
                    options.footer = `Example: ${command.example}`;
                }
                if (command.deprecated) {
                    options.title = "[DEPRECATED] " + options.title;
                    options.description +=
                        "\n*This command is deprecated and can no longer be used*";
                    options.color = 13107200;
                }
                command.help.forEach((usage) => {
                    if (usage.effect) {
                        options.fields.push({
                            title: `${Salty.config.prefix}${command.name} ${usage.argument || ""}`,
                            description: usage.effect,
                        });
                    }
                });
            }
            else {
                throw new IncorrectValue("second argument", "command or a category");
            }
            // no query: displays all commands
        }
        else {
            options.title = "list of commands";
            options.description =
                "these are the commands categories. To get more information about a specific category, use the command `$help category_name`";
            for (let category in help) {
                const { name, icon } = help[category].info;
                options.fields.push({
                    title: `${icon} **${title(name)}**  (${help[category].commands.length} commands)`,
                    description: `> \`${Salty.config.prefix}help ${category}\``,
                });
            }
        }
        await Salty.embed(msg, options);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmFsL2hlbHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3pELE9BQU8sS0FBSyxNQUFNLHFCQUFxQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFcEMsZUFBZSxJQUFJLE9BQU8sQ0FBQztJQUN2QixJQUFJLEVBQUUsTUFBTTtJQUNaLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUM7SUFDM0MsSUFBSSxFQUFFO1FBQ0Y7WUFDSSxRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxnREFBZ0Q7U0FDM0Q7UUFDRDtZQUNJLFFBQVEsRUFBRSxnQkFBZ0I7WUFDMUIsTUFBTSxFQUFFLDBEQUEwRDtTQUNyRTtRQUNEO1lBQ0ksUUFBUSxFQUFFLGVBQWU7WUFDekIsTUFBTSxFQUFFLG9EQUFvRDtTQUMvRDtLQUNKO0lBQ0QsVUFBVSxFQUFFLFFBQVE7SUFDcEIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsSUFBSTtRQUNsQixNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQ3ZCLE1BQU0sT0FBTyxHQUFHO1lBQ1osS0FBSyxFQUFFLFFBQVE7WUFDZixNQUFNLEVBQUUsRUFBRTtTQUNiLENBQUM7UUFDRixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNqQyxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDdEIsa0RBQWtEO1FBQ2xELEtBQUssSUFBSSxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ3ZCLFVBQVUsQ0FBQyxRQUFRLENBQUMs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aUIsRUFDakIsdUJBQXVCLENBQzFCLENBQUM7YUFDTDtZQUNELGtDQUFrQztTQUNyQzthQUFNO1lBQ0gsT0FBTyxDQUFDLEtBQUssR0FBRyxrQkFBa0IsQ0FBQztZQUNuQyxPQUFPLENBQUMsV0FBVztnQkFDZiw2SEFBNkgsQ0FBQztZQUNsSSxLQUFLLElBQUksUUFBUSxJQUFJLElBQUksRUFBRTtnQkFDdkIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMzQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztvQkFDaEIsS0FBSyxFQUFFLEdBQUcsSUFBSSxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUM1QixZQUFZO29CQUNaLFdBQVcsRUFBRSxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxRQUFRLFFBQVEsSUFBSTtpQkFDOUQsQ0FBQyxDQUFDO2FBQ047U0FDSjtRQUNELE1BQU0sS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEMsQ0FBQztDQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb21tYW5kIGZyb20gXCIuLi8uLi9jbGFzc2VzL0NvbW1hbmRcIjtcbmltcG9ydCB7IEluY29ycmVjdFZhbHVlIH0gZnJvbSBcIi4uLy4uL2NsYXNzZXMvRXhjZXB0aW9uXCI7XG5pbXBvcnQgU2FsdHkgZnJvbSBcIi4uLy4uL2NsYXNzZXMvU2FsdHlcIjtcbmltcG9ydCB7IHRpdGxlIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBDb21tYW5kKHtcbiAgICBuYW1lOiBcImhlbHBcIixcbiAgICBrZXlzOiBbXCJoYWxwXCIsIFwiaW5mb1wiLCBcImluZm9zXCIsIFwid3RmXCIsIFwiP1wiXSxcbiAgICBoZWxwOiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIGFyZ3VtZW50OiBudWxsLFxuICAgICAgICAgICAgZWZmZWN0OiBcIlNob3dzIGFsbCBvZiB0aGUgYXZhaWxhYmxlIGNvbW1hbmRzIGNhdGVnb3JpZXNcIixcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgICAgYXJndW1lbnQ6IFwiKioqY2F0ZWdvcnkqKipcIixcbiAgICAgICAgICAgIGVmZmVjdDogXCJTaG93cyBhbGwgb2YgdGhlIGF2YWlsYWJsZSBjb21tYW5kcyBmb3IgYSAqKipjYXRlZ29yeSoqKlwiLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBhcmd1bWVudDogXCIqKipjb21tYW5kKioqXCIsXG4gICAgICAgICAgICBlZmZlY3Q6IFwiU2hvd3MgYSBkZXRhaWxlZCB1c2FnZSBvZiBhIHNwZWNpZmljICoqKmNvbW1hbmQqKipcIixcbiAgICAgICAgfSxcbiAgICBdLFxuICAgIHZpc2liaWxpdHk6IFwicHVibGljXCIsXG4gICAgYXN5bmMgYWN0aW9uKG1zZywgYXJncykge1xuICAgICAgICBjb25zdCB7IGF1dGhvciB9ID0gbXNnO1xuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAgY29sb3I6IDB4ZmZmZmZmLFxuICAgICAgICAgICAgZmllbGRzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgaGVscCA9IFNhbHR5LmNvbW1hbmRzLmhlbHA7XG4gICAgICAgIGNvbnN0IGNhdGVnb3JpZXMgPSB7fTtcbiAgICAgICAgLy8gbWFwIG5hbWUgYW5kIHRlY2huaWNhbCBuYW1lIGZvciBlbmhhbmNlZCBzZWFyY2hcbiAgICAgICAgZm9yIChsZXQgY2F0ZWdvcnkgaW4gaGVscCkge1xuICAgICAgICAgICAgY2F0ZWdvcmllc1tjYXRlZ29yeV0gPSBjYXRlZ29yeTtcbiAgICAgICAgICAgIGNhdGVnb3JpZXNbaGVscFtjYXRlZ29yeV0uaW5mby5uYW1lXSA9IGNhdGVnb3J5O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvbW1hbmRzID0gT2JqZWN0LmtleXMoU2FsdHkuY29tbWFuZHMua2V5cyk7XG5cbiAgICAgICAgaWYgKGFyZ3NbMF0pIHtcbiAgICAgICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbMF0udG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgLy8gcXVlcnkgaXMgYSBjYXRlZ29yeSBuYW1lXG4gICAgICAgICAgICBpZiAoYXJnIGluIGNhdGVnb3JpZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IG5hbWUsIGRlc2NyaXB0aW9uLCBpY29uIH0gPSBoZWxwW2NhdGVnb3JpZXNbYXJnXV0uaW5mbztcbiAgICAgICAgICAgICAgICAvLyBhcmcgPT09IGNhdGVnb3J5XG4gICAgICAgICAgICAgICAgb3B0aW9ucy50aXRsZSA9IGAke2ljb259ICR7dGl0bGUobmFtZSl9IGNvbW1hbmRzYDtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmRlc2NyaXB0aW9uID0gYCR7ZGVzY3JpcHRpb259LiBUbyBnZXQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhIHNwZWNpZmljIGNvbW1hbmQsIHVzZSB0aGUgY29tbWFuZCBcXGAkaGVscCBjb21tYW5kX25hbWVcXGBgO1xuXG4gICAgICAgICAgICAgICAgaGVscFtjYXRlZ29yaWVzW2FyZ11dLmNvbW1hbmRzLmZvckVhY2goKGNtZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICBcInB1YmxpY1wiID09PSBjbWQudmlzaWJpbGl0eSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKFwiYWRtaW5cIiA9PT0gY21kLnZpc2liaWxpdHkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTYWx0eS5pc0FkbWluKGF1dGhvciwgbXNnLmd1aWxkKSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIChcImRldlwiID09PSBjbWQudmlzaWJpbGl0eSAmJiBTYWx0eS5pc0RldihhdXRob3IpKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKFwib3duZXJcIiA9PT0gY21kLnZpc2liaWxpdHkgJiYgU2FsdHkuaXNPd25lcihhdXRob3IpKVxuICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsdGVybmF0ZSA9IGNtZC5rZXlzLmxlbmd0aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYCAob3IgKioqJHtjbWQua2V5cy5qb2luKFwiKioqLCAqKipcIil9KioqKWBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmZpZWxkcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogYCoqJHt0aXRsZShjbWQubmFtZSl9Kioke2FsdGVybmF0ZX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgPiBcXGAke1NhbHR5LmNvbmZpZy5wcmVmaXh9aGVscCAke2NtZC5uYW1lfVxcYGAsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vIHF1ZXJ5IGlzIGEgY29tbWFuZCBuYW1lXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmRzLmluY2x1ZGVzKGFyZykpIHtcbiAgICAgICAgICAgICAgICAvLyBhcmcgPT09IGNvbW1hbmRcbiAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gU2FsdHkuY29tbWFuZHMubGlzdC5nZXQoXG4gICAgICAgICAgICAgICAgICAgIFNhbHR5LmNvbW1hbmRzLmtleXNbYXJnXVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgY29uc3QgY2F0ZWdvcnkgPSBPYmplY3QudmFsdWVzKGNhdGVnb3JpZXMpLmZpbmQoKGNhdCkgPT5cbiAgICAgICAgICAgICAgICAgICAgaGVscFtjYXRdLmNvbW1hbmRzLmZpbmQoKGNtZCkgPT4gY21kLm5hbWUgPT09IGNvbW1hbmQubmFtZSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG9wdGlvbnMudGl0bGUgPSBgKioke2NvbW1hbmQubmFtZS50b1VwcGVyQ2FzZSgpfSoqYDtcbiAgICAgICAgICAgICAgICBvcHRpb25zLnVybCA9IGAke1xuICAgICAgICAgICAgICAgICAgICBTYWx0eS5jb25maWcuaG9tZXBhZ2VcbiAgICAgICAgICAgICAgICB9L3RyZWUvbWFzdGVyL2NvbW1hbmRzLyR7Y2F0ZWdvcnl9LyR7Y29tbWFuZC5uYW1lLnRvTG93ZXJDYXNlKCl9LmpzYDtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmRlc2NyaXB0aW9uID0gYD4gJHt0aXRsZShjYXRlZ29yeSl9YDtcbiAgICAgICAgICAgICAgICBpZiAoMCA8IGNvbW1hbmQua2V5cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5kZXNjcmlwdGlvbiArPSBgXFxuQWx0ZXJuYXRpdmUgdXNhZ2U6ICoqJHtjb21tYW5kLmtleXMuam9pbihcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiKiosICoqXCJcbiAgICAgICAgICAgICAgICAgICAgKX0qKmA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmV4YW1wbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5mb290ZXIgPSBgRXhhbXBsZTogJHtjb21tYW5kLmV4YW1wbGV9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuZGVwcmVjYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRpdGxlID0gXCJbREVQUkVDQVRFRF0gXCIgKyBvcHRpb25zLnRpdGxlO1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmRlc2NyaXB0aW9uICs9XG4gICAgICAgICAgICAgICAgICAgICAgICBcIlxcbipUaGlzIGNvbW1hbmQgaXMgZGVwcmVjYXRlZCBhbmQgY2FuIG5vIGxvbmdlciBiZSB1c2VkKlwiO1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNvbG9yID0gMTMxMDcyMDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbW1hbmQuaGVscC5mb3JFYWNoKCh1c2FnZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodXNhZ2UuZWZmZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmZpZWxkcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogYCR7U2FsdHkuY29uZmlnLnByZWZpeH0ke2NvbW1hbmQubmFtZX0gJHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNhZ2UuYXJndW1lbnQgfHwgXCJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB1c2FnZS5lZmZlY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW5jb3JyZWN0VmFsdWUoXG4gICAgICAgICAgICAgICAgICAgIFwic2Vjb25kIGFyZ3VtZW50XCIsXG4gICAgICAgICAgICAgICAgICAgIFwiY29tbWFuZCBvciBhIGNhdGVnb3J5XCJcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gbm8gcXVlcnk6IGRpc3BsYXlzIGFsbCBjb21tYW5kc1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3B0aW9ucy50aXRsZSA9IFwibGlzdCBvZiBjb21tYW5kc1wiO1xuICAgICAgICAgICAgb3B0aW9ucy5kZXNjcmlwdGlvbiA9XG4gICAgICAgICAgICAgICAgXCJ0aGVzZSBhcmUgdGhlIGNvbW1hbmRzIGNhdGVnb3JpZXMuIFRvIGdldCBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGEgc3BlY2lmaWMgY2F0ZWdvcnksIHVzZSB0aGUgY29tbWFuZCBgJGhlbHAgY2F0ZWdvcnlfbmFtZWBcIjtcbiAgICAgICAgICAgIGZvciAobGV0IGNhdGVnb3J5IGluIGhlbHApIHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IG5hbWUsIGljb24gfSA9IGhlbHBbY2F0ZWdvcnldLmluZm87XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5maWVsZHMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBgJHtpY29ufSAqKiR7dGl0bGUobmFtZSl9KiogICgke1xuICAgICAgICAgICAgICAgICAgICAgICAgaGVscFtjYXRlZ29yeV0uY29tbWFuZHMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgIH0gY29tbWFuZHMpYCxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGA+IFxcYCR7U2FsdHkuY29uZmlnLnByZWZpeH1oZWxwICR7Y2F0ZWdvcnl9XFxgYCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBTYWx0eS5lbWJlZChtc2csIG9wdGlvbnMpO1xuICAgIH0sXG59KTtcbiJdfQ==